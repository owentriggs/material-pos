<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashier POS System</title>
    <!-- Tailwind CSS with JIT CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2eTDRqHk+oUv5z0P/W8Gz6F0H/Ea9/nQ8+K2/M5Z5aC5dF49+rFfE5d1A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Inter & Roboto Flex Fonts from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Flex:opsz,wght@8..144,400;8..144,700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: 25, 120, 240;
            --on-primary: 255, 255, 255;
            --primary-container: 220, 235, 255;
            --on-primary-container: 0, 30, 60;
            --secondary: 105, 170, 120;
            --on-secondary: 255, 255, 255;
            --secondary-container: 200, 230, 210;
            --on-secondary-container: 10, 45, 20;
            --surface: 255, 255, 255;
            --on-surface: 20, 20, 20;
            --surface-container-low: 245, 245, 245;
            --outline: 180, 180, 180;
            --error: 180, 40, 40;
            --on-error: 255, 255, 255;
            --grid-columns: 3; /* CSS variable for dynamic columns */
        }

        /* Dark Mode colors */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: 155, 205, 255;
                --on-primary: 0, 30, 60;
                --primary-container: 0, 30, 60;
                --on-primary-container: 255, 255, 255;
                --secondary: 180, 220, 190;
                --on-secondary: 30, 50, 20;
                --secondary-container: 30, 50, 20;
                --on-secondary-container: 255, 255, 255;
                --surface: 20, 20, 20;
                --on-surface: 255, 255, 255;
                --surface-container-low: 30, 30, 30;
                --outline: 70, 70, 70;
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: rgb(var(--surface-container-low));
            color: rgb(var(--on-surface));
            transition: background-color 0.3s, color 0.3s;
        }

        /* Material 3 Color Roles */
        .primary-bg { background-color: rgb(var(--primary)); }
        .on-primary-text { color: rgb(var(--on-primary)); }
        .primary-container-bg { background-color: rgb(var(--primary-container)); }
        .on-primary-container-text { color: rgb(var(--on-primary-container)); }
        .secondary-bg { background-color: rgb(var(--secondary)); }
        .on-secondary-text { color: rgb(var(--on-secondary)); }
        .secondary-container-bg { background-color: rgb(var(--secondary-container)); }
        .on-secondary-container-text { color: rgb(var(--on-secondary-container)); }
        .surface-bg { background-color: rgb(var(--surface)); }
        .on-surface-text { color: rgb(var(--on-surface)); }
        .surface-container-low-bg { background-color: rgb(var(--surface-container-low)); }
        .outline-border { border-color: rgb(var(--outline)); }
        .on-surface-variant-text { color: rgba(var(--on-surface), 0.7); }
        .error-text { color: rgb(var(--error)); }

        /* Material 3 Typography */
        .headline-medium { font-size: 28px; line-height: 36px; font-weight: 400; }
        .title-large { font-size: 22px; line-height: 28px; font-weight: 400; }
        .title-medium { font-size: 16px; line-height: 24px; font-weight: 500; }
        .title-small { font-size: 14px; line-height: 20px; font-weight: 500; }
        .body-large { font-size: 16px; line-height: 24px; font-weight: 400; }
        .body-medium { font-size: 14px; line-height: 20px; font-weight: 400; }
        .label-large { font-size: 14px; line-height: 20px; font-weight: 500; }
        .label-medium { font-size: 12px; line-height: 16px; font-weight: 500; }
        /* Custom styles for new display text */
        .display-large {
            font-family: 'Roboto Flex', sans-serif;
            font-size: 4rem; /* 64px */
            line-height: 1;
            font-weight: 400;
        }
        
        /* Material 3 Buttons & Components */
        .filled-button {
            background-color: rgb(var(--primary));
            color: rgb(var(--on-primary));
        }
        .filled-button-error {
            background-color: rgb(var(--error));
            color: rgb(var(--on-error));
        }
        .outlined-button {
            border: 1px solid rgb(var(--outline));
            color: rgb(var(--primary));
        }
        .text-button {
            color: rgb(var(--primary));
        }
        .icon-button {
            color: rgba(var(--on-surface), 0.7);
            transition: color 0.2s;
        }
        .icon-button:hover {
            color: rgb(var(--on-surface));
        }

        .item-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-radius: 1rem;
            background-color: rgb(var(--surface));
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
            cursor: pointer;
        }

        .item-card:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .item-grid {
            display: grid;
            gap: 1rem;
            /* Use the CSS variable for dynamic columns */
            grid-template-columns: repeat(var(--grid-columns), minmax(0, 1fr));
            /* This is the key fix: makes all rows the same height */
            grid-auto-rows: 1fr;
        }
        
        /* Navigation Rail */
        .nav-rail {
            background-color: rgb(var(--surface));
            box-shadow: 4px 0 8px -4px rgba(0, 0, 0, 0.1);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            color: rgba(var(--on-surface), 0.7);
            transition: color 0.2s;
            cursor: pointer;
        }
        .nav-item.active {
            color: rgb(var(--on-primary-container));
            background-color: rgb(var(--primary-container));
            border-radius: 1.5rem;
        }

        /* Set a fixed size for Font Awesome icons to prevent layout shifts */
        .fa-solid {
            font-size: 24px;
            margin-bottom: 0.25rem;
        }

        /* Dialog Animation */
        .dialog {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.2s, transform 0.2s;
        }
        .dialog.open {
            opacity: 1;
            transform: scale(1);
        }

        /* Snackbar/Message Animation */
        .snackbar {
            opacity: 0;
            transform: translateY(100%);
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .snackbar.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Mobile Cart Overlay */
        #cart-panel.mobile-overlay {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            z-index: 40;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: none; /* Initial state on mobile */
        }
        
        #cart-panel.mobile-overlay.open {
            transform: translateX(0);
            display: flex; /* Display when opened */
        }
        
        /* Material 3 Expressive Slider Emulation */
        .slider-container {
            position: relative;
            height: 48px; /* Height for the track and thumb */
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 12px;
            background: transparent;
            cursor: pointer;
            outline: none;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            touch-action: none; /* Prevents unwanted scrolling on touch devices */
        }
        
        /* Track */
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: rgb(var(--primary-container));
            border-radius: 9999px;
            overflow: hidden;
            position: relative;
        }
        
        /* Active Track - a pseudo-element on the track */
        input[type="range"]::-webkit-slider-runnable-track::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: var(--thumb-position, 0%);
            height: 100%;
            background: rgb(var(--primary));
            border-radius: inherit;
        }

        /* Thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 48px;
            width: 48px;
            background-color: rgb(var(--primary));
            border-radius: 9999px;
            cursor: grab;
            margin-top: -20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.2s, box-shadow 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        input[type="range"]:active::-webkit-slider-thumb {
            cursor: grabbing;
        }
        
        /* Thumb value label (using a pseudo-element) */
        input[type="range"]::-webkit-slider-thumb::before {
            content: attr(data-value);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgb(var(--on-primary));
            font-size: 14px;
            font-weight: 500;
        }

        /* Firefox support */
        input[type="range"]::-moz-range-track {
            width: 100%;
            height: 8px;
            background: rgb(var(--primary-container));
            border-radius: 9999px;
            overflow: hidden;
            position: relative;
        }
        input[type="range"]::-moz-range-progress {
            background: rgb(var(--primary));
            height: 100%;
            border-radius: 9999px;
        }
        input[type="range"]::-moz-range-thumb {
            height: 48px;
            width: 48px;
            background-color: rgb(var(--primary));
            border-radius: 9999px;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.2s, box-shadow 0.2s;
            border: none;
        }
    </style>
</head>
<body class="flex h-screen">

    <!-- Navigation Rail -->
    <nav class="nav-rail w-24 flex flex-col items-center py-6">
        <a href="#sale" class="nav-item active" data-view="sale">
            <i class="fa-solid fa-cash-register"></i>
            <span class="label-medium">Sale</span>
        </a>
        <a href="#items" class="nav-item mt-4" data-view="items">
            <i class="fa-solid fa-boxes-stacked"></i>
            <span class="label-medium">Items</span>
        </a>
        <a href="#settings" class="nav-item mt-4" data-view="settings">
            <i class="fa-solid fa-gear"></i>
            <span class="label-medium">Settings</span>
        </a>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow flex flex-col md:flex-row">
        <!-- Sale View -->
        <div id="sale-view" class="flex-1 p-6 overflow-y-auto" data-view-content>
            <h1 class="headline-medium mb-6 on-surface-text">Quick Sale</h1>
            <div id="item-panel" class="flex flex-col h-full">
                <input type="text" id="item-search-input" placeholder="Search items..." class="px-4 py-2 rounded-xl on-surface-text primary-container-bg placeholder-on-primary-container-text focus:outline-none focus:ring-2 focus:ring-primary mb-6">
                <div id="item-grid" class="item-grid flex-grow">
                    <!-- Item cards will be rendered here -->
                </div>
            </div>
            
            <!-- Mobile-only "View Cart" button -->
            <button id="mobile-cart-btn" class="md:hidden fixed bottom-4 right-4 z-30 filled-button rounded-full py-3 px-6 shadow-lg flex items-center gap-2">
                <i class="fa-solid fa-cart-shopping fa-xl on-primary-text"></i>
                <span id="mobile-cart-total" class="label-large">Â£0.00</span>
            </button>
        </div>

        <!-- Items Management View -->
        <div id="items-view" class="flex-1 p-6 overflow-y-auto hidden" data-view-content>
            <div class="flex items-center justify-between pb-4 mb-4 border-b outline-border">
                <h1 class="headline-medium on-surface-text">Item Catalog</h1>
                <button id="add-item-btn" class="filled-button px-4 py-2 rounded-xl label-large">Add New Item</button>
            </div>
            <div class="flex-1 overflow-y-auto py-4">
                <ul id="catalog-list" class="space-y-4">
                    <!-- Catalog items will be rendered here -->
                </ul>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settings-view" class="flex-1 p-6 overflow-y-auto hidden" data-view-content>
            <h1 class="headline-medium mb-6 on-surface-text">Settings</h1>
            <div class="surface-bg rounded-2xl p-6 shadow-md mb-6">
                <h3 class="title-large mb-4">Display Grid</h3>
                <p class="body-medium on-surface-variant-text mb-4">Set the number of columns to display on the quick sale screen.</p>
                <div class="flex flex-col items-center">
                    <p class="title-medium mb-2">Columns: <span id="column-count-display"></span></p>
                    <div class="slider-container w-full">
                        <input type="range" id="column-slider" min="1" max="5" step="1">
                    </div>
                </div>
            </div>
            <div class="surface-bg rounded-2xl p-6 shadow-md">
                <h3 class="title-large mb-4">Tax Configuration</h3>
                <p class="body-medium on-surface-variant-text mb-4">Set the sales tax percentage. The current tax rate is <span id="current-tax-rate" class="font-bold"></span>%.</p>
                <div class="flex items-end gap-4">
                    <div class="flex-grow">
                        <label for="tax-rate-input" class="label-medium">Tax Percentage</label>
                        <input type="number" id="tax-rate-input" step="0.01" min="0" max="100" class="w-full px-4 py-3 rounded-xl on-surface-text primary-container-bg placeholder-on-primary-container-text focus:outline-none focus:ring-2 focus:ring-primary" placeholder="e.g., 5 for 5%">
                    </div>
                    <button id="save-tax-btn" class="filled-button px-4 py-3 rounded-xl label-large">Save</button>
                </div>
            </div>
        </div>
        
        <!-- Cart and Checkout Panel (Right) -->
        <div id="cart-panel" class="md:flex flex-col p-6 border-t md:border-t-0 md:border-l outline-border surface-bg md:w-96">
            <!-- Mobile-only close button -->
            <div class="flex items-center justify-between md:hidden">
                <h2 class="title-large on-surface-text">Current Order</h2>
                <button id="close-cart-btn" class="icon-button p-2 rounded-full">
                    <i class="fa-solid fa-xmark fa-xl"></i>
                </button>
            </div>
            
            <!-- Cart content -->
            <h2 class="title-large mb-4 on-surface-text hidden md:block">Current Order</h2>
            <div class="flex-grow overflow-y-auto pr-2">
                <ul id="cart-list" class="space-y-4">
                    <!-- Cart items will be rendered here -->
                </ul>
            </div>
            
            <!-- Cart Summary & Actions -->
            <div class="mt-4 pt-4 border-t outline-border on-surface-text">
                <div class="flex justify-between title-medium mb-1">
                    <span>Subtotal</span>
                    <span id="subtotal-amount">Â£0.00</span>
                </div>
                <div class="flex justify-between title-medium mb-1">
                    <span>Tax (<span id="tax-percentage">5</span>%)</span>
                    <span id="tax-amount">Â£0.00</span>
                </div>
                <div class="flex justify-between headline-medium mt-2 mb-4">
                    <span>Total</span>
                    <span id="total-amount">Â£0.00</span>
                </div>
                <!-- M3 Button Group -->
                <div class="flex gap-2 mb-4">
                    <button id="void-btn" class="outlined-button flex-1 py-3 rounded-2xl font-medium label-large">Void All</button>
                    <button id="checkout-btn" class="filled-button flex-1 py-3 rounded-2xl font-medium label-large">
                        Checkout
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Dialog Overlays for different pop-ups -->
    <div id="dialog-overlay" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        
        <!-- Checkout Dialog -->
        <div id="checkout-dialog" class="dialog hidden surface-bg rounded-2xl shadow-xl w-full max-w-sm p-6 space-y-4">
            <h3 class="title-large on-surface-text">Select Payment Method</h3>
            <div id="checkout-steps" class="space-y-4">
                <!-- Step 1: Payment Method Selection -->
                <div id="payment-step-1">
                    <button id="pay-cash-btn" class="filled-button w-full py-3 rounded-xl label-large mb-2">Pay with Cash</button>
                    <button id="pay-card-btn" class="filled-button w-full py-3 rounded-xl label-large mb-2">Pay with Card</button>
                    <button id="checkout-cancel-btn" class="text-button w-full py-3 rounded-xl label-large">Cancel</button>
                </div>
                <!-- Stage 1: Cash Amount Input -->
                <div id="cash-stage-1" class="hidden flex flex-col items-center text-center">
                    <p class="body-medium on-surface-variant-text mb-2">Total Due</p>
                    <p id="total-due-display" class="on-surface-text display-large mb-4">Â£0.00</p>
                    <label for="cash-received-input" class="label-medium block mb-1">Cash Given</label>
                    <input type="number" id="cash-received-input" step="0.01" class="w-full px-4 py-3 rounded-xl on-surface-text primary-container-bg placeholder-on-primary-container-text focus:outline-none focus:ring-2 focus:ring-primary mb-4 text-center" placeholder="Enter cash amount">
                    
                    <!-- Preset cash buttons -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button class="cash-preset-btn outlined-button px-4 py-2 rounded-xl label-large" data-value="1">Â£1</button>
                        <button class="cash-preset-btn outlined-button px-4 py-2 rounded-xl label-large" data-value="5">Â£5</button>
                        <button class="cash-preset-btn outlined-button px-4 py-2 rounded-xl label-large" data-value="10">Â£10</button>
                        <button class="cash-preset-btn outlined-button px-4 py-2 rounded-xl label-large" data-value="20">Â£20</button>
                        <button id="exact-cash-btn" class="outlined-button px-4 py-2 rounded-xl label-large">Exact</button>
                    </div>

                    <button id="cash-continue-btn" class="filled-button w-full py-3 rounded-xl label-large">Continue</button>
                    <button id="cash-back-1-btn" class="text-button w-full py-3 rounded-xl label-large mt-2">Back</button>
                </div>
                <!-- Stage 2: Change Due Display -->
                <div id="cash-stage-2" class="hidden flex flex-col items-center text-center">
                    <p class="body-medium on-surface-variant-text mb-2">Total: <span id="total-display-small" class="font-bold on-surface-text">Â£0.00</span></p>
                    <p class="body-medium on-surface-variant-text">Change Due</p>
                    <p id="change-display" class="on-surface-text display-large mb-4">Â£0.00</p>
                    <button id="complete-transaction-btn" class="filled-button w-full py-3 rounded-xl label-large">Complete Transaction</button>
                    <button id="cash-back-2-btn" class="text-button w-full py-3 rounded-xl label-large mt-2">Back</button>
                </div>
            </div>
        </div>
        
        <!-- Add/Edit Item Form Dialog -->
        <div id="item-form-dialog" class="dialog hidden surface-bg rounded-2xl shadow-xl w-full max-w-sm p-6 space-y-4">
            <h3 id="item-form-title" class="title-large on-surface-text">Add New Item</h3>
            <form id="item-form" class="space-y-4">
                <div>
                    <label for="item-name" class="label-medium">Item Name</label>
                    <input type="text" id="item-name" class="w-full px-4 py-3 rounded-xl on-surface-text primary-container-bg placeholder-on-primary-container-text focus:outline-none focus:ring-2 focus:ring-primary" placeholder="e.g., Apple Pie" required>
                </div>
                <div>
                    <label for="item-price" class="label-medium">Price</label>
                    <input type="number" id="item-price" step="0.01" min="0" class="w-full px-4 py-3 rounded-xl on-surface-text primary-container-bg placeholder-on-primary-container-text focus:outline-none focus:ring-2 focus:ring-primary" placeholder="e.g., 5.99" required>
                </div>
                <div>
                    <label for="item-emoji" class="label-medium">Emoji</label>
                    <input type="text" id="item-emoji" maxlength="2" class="w-full px-4 py-3 rounded-xl on-surface-text primary-container-bg placeholder-on-primary-container-text focus:outline-none focus:ring-2 focus:ring-primary" placeholder="e.g., ðŸ¥§" required>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="item-form-cancel-btn" class="text-button px-4 py-2 rounded-xl font-medium label-large">Cancel</button>
                    <button type="submit" class="filled-button px-4 py-2 rounded-xl font-medium label-large">Save Item</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Snackbar for user feedback -->
    <div id="snackbar" class="snackbar fixed bottom-4 md:bottom-auto md:top-4 left-1/2 -translate-x-1/2 primary-container-bg on-primary-container-text px-4 py-3 rounded-xl shadow-xl z-50 text-sm font-medium">
        <span id="snackbar-message"></span>
    </div>

    <script>
        // Define initial catalog data
        const initialProducts = [
            { id: 'p_1', name: 'Chocolate Chip Cookie', price: 2.50, image: 'ðŸª' },
            { id: 'p_2', name: 'Lemonade', price: 1.00, image: 'ðŸ‹' },
            { id: 'p_3', name: 'Chocolate Brownie', price: 1.75, image: 'ðŸ«' },
            { id: 'p_4', name: 'Iced Coffee', price: 3.50, image: 'â˜•' },
            { id: 'p_5', name: 'Banana Bread', price: 4.25, image: 'ðŸŒ' },
            { id: 'p_6', name: 'Strawberry Smoothie', price: 5.00, image: 'ðŸ“' },
            { id: 'p_7', name: 'Blueberry Muffin', price: 2.75, image: 'ðŸ«' },
            { id: 'p_8', name: 'Hot Tea', price: 2.00, image: 'ðŸµ' },
            { id: 'p_9', name: 'Croissant', price: 3.00, image: 'ðŸ¥' },
        ];

        // --- DOM Elements ---
        const navItems = document.querySelectorAll('.nav-item');
        const viewContents = document.querySelectorAll('[data-view-content]');
        const itemGrid = document.getElementById('item-grid');
        const cartList = document.getElementById('cart-list');
        const subtotalAmount = document.getElementById('subtotal-amount');
        const taxAmount = document.getElementById('tax-amount');
        const totalAmount = document.getElementById('total-amount');
        const taxPercentageSpan = document.getElementById('tax-percentage');
        const dialogOverlay = document.getElementById('dialog-overlay');
        const checkoutDialog = document.getElementById('checkout-dialog');
        const itemFormDialog = document.getElementById('item-form-dialog');
        const catalogList = document.getElementById('catalog-list');
        const snackbar = document.getElementById('snackbar');
        const snackbarMessage = document.getElementById('snackbar-message');
        const itemSearchInput = document.getElementById('item-search-input');
        const taxRateInput = document.getElementById('tax-rate-input');
        const currentTaxRateSpan = document.getElementById('current-tax-rate');
        
        // New slider elements
        const columnSlider = document.getElementById('column-slider');
        const columnCountDisplay = document.getElementById('column-count-display');

        // Mobile UI elements
        const mobileCartBtn = document.getElementById('mobile-cart-btn');
        const mobileCartTotalSpan = document.getElementById('mobile-cart-total');
        const cartPanel = document.getElementById('cart-panel');
        const closeCartBtn = document.getElementById('close-cart-btn');

        // New cash checkout DOM elements
        const paymentStep1 = document.getElementById('payment-step-1');
        const cashStage1 = document.getElementById('cash-stage-1');
        const cashStage2 = document.getElementById('cash-stage-2');
        const totalDueDisplay = document.getElementById('total-due-display');
        const cashReceivedInput = document.getElementById('cash-received-input');
        const cashPresetButtons = document.querySelectorAll('.cash-preset-btn');
        const exactCashButton = document.getElementById('exact-cash-btn');
        const cashContinueBtn = document.getElementById('cash-continue-btn');
        const totalDisplaySmall = document.getElementById('total-display-small');
        const changeDisplay = document.getElementById('change-display');
        const completeTransactionBtn = document.getElementById('complete-transaction-btn');
        const cashBack1Btn = document.getElementById('cash-back-1-btn');
        const cashBack2Btn = document.getElementById('cash-back-2-btn');

        // --- State Management ---
        let cart = [];
        let products = [];
        let editItemIndex = -1;
        let taxRate = 0.05; // Default tax rate
        let currentTotal = 0; // Store the total for the cash checkout process
        let gridColumns = 3; // Default grid column count

        /**
         * Loads the tax rate, grid columns, and item catalog from localStorage.
         */
        const loadState = () => {
            const storedCatalog = localStorage.getItem('posCatalog');
            if (storedCatalog) {
                products = JSON.parse(storedCatalog);
            } else {
                products = initialProducts;
                saveCatalog();
            }

            const storedTax = localStorage.getItem('posTaxRate');
            if (storedTax) {
                taxRate = parseFloat(storedTax);
            }
            
            const storedColumns = localStorage.getItem('posGridColumns');
            if (storedColumns) {
                gridColumns = parseInt(storedColumns, 10);
            }
        };

        /**
         * Saves the current catalog to localStorage.
         */
        const saveCatalog = () => {
            localStorage.setItem('posCatalog', JSON.stringify(products));
        };

        /**
         * Saves the current tax rate to localStorage.
         */
        const saveTaxRate = () => {
            localStorage.setItem('posTaxRate', taxRate);
        };
        
        /**
         * Saves the current column count to localStorage.
         */
        const saveGridColumns = () => {
            localStorage.setItem('posGridColumns', gridColumns);
        };

        /**
         * Shows a temporary snackbar message for user feedback.
         * @param {string} message - The message to display.
         */
        const showSnackbar = (message) => {
            snackbarMessage.textContent = message;
            snackbar.classList.add('show');
            setTimeout(() => {
                snackbar.classList.remove('show');
            }, 3000);
        };

        /**
         * Shows a dialog modal and animates it in.
         * @param {HTMLElement} dialogElement - The dialog to show.
         */
        const showDialog = (dialogElement) => {
            dialogOverlay.classList.remove('hidden');
            dialogOverlay.classList.add('flex');
            dialogElement.classList.remove('hidden');
            setTimeout(() => dialogElement.classList.add('open'), 10);
        };

        /**
         * Hides all dialogs.
         */
        const hideAllDialogs = () => {
            checkoutDialog.classList.remove('open', 'flex');
            itemFormDialog.classList.remove('open', 'flex');

            setTimeout(() => {
                dialogOverlay.classList.remove('flex');
                dialogOverlay.classList.add('hidden');
                checkoutDialog.classList.add('hidden');
                itemFormDialog.classList.add('hidden');
            }, 200);
        };

        /**
         * Switches the active view based on the nav item clicked.
         * @param {string} viewId - The ID of the view to show.
         */
        const showView = (viewId) => {
            viewContents.forEach(view => {
                if (view.id === `${viewId}-view`) {
                    view.classList.remove('hidden');
                } else {
                    view.classList.add('hidden');
                }
            });
            navItems.forEach(nav => {
                if (nav.dataset.view === viewId) {
                    nav.classList.add('active');
                } else {
                    nav.classList.remove('active');
                }
            });
            // Update UI for the new view
            if (viewId === 'sale') {
                renderItems();
            } else if (viewId === 'items') {
                renderCatalogList();
            } else if (viewId === 'settings') {
                taxRateInput.value = (taxRate * 100).toFixed(2);
                currentTaxRateSpan.textContent = (taxRate * 100).toFixed(2);
                columnSlider.value = gridColumns;
                columnCountDisplay.textContent = gridColumns;
                document.documentElement.style.setProperty('--grid-columns', gridColumns);
                // Also update the slider's filled track
                const percentage = ((columnSlider.value - columnSlider.min) / (columnSlider.max - columnSlider.min)) * 100;
                document.documentElement.style.setProperty('--thumb-position', `${percentage}%`);
            }
        };

        /**
         * Renders the item buttons in the main grid.
         * @param {Array} filteredItems - An optional array of items to filter the display.
         */
        const renderItems = (filteredItems = products) => {
            itemGrid.innerHTML = '';
            filteredItems.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card';
                itemCard.innerHTML = `
                    <div class="flex flex-col items-center flex-grow text-center mb-2">
                        <span class="text-4xl mb-2">${item.image}</span>
                        <h3 class="title-small font-medium">${item.name}</h3>
                    </div>
                    <p class="body-medium on-surface-variant-text">Â£${item.price.toFixed(2)}</p>
                `;
                itemCard.dataset.id = item.id;
                itemCard.addEventListener('click', () => addItemToCart(item));
                itemGrid.appendChild(itemCard);
            });
        };

        /**
         * Renders the cart items in the side panel.
         */
        const renderCart = () => {
            cartList.innerHTML = '';
            if (cart.length === 0) {
                cartList.innerHTML = `<li class="body-medium on-surface-variant-text text-center py-8">Cart is empty.</li>`;
                document.getElementById('checkout-btn').disabled = true;
                document.getElementById('void-btn').disabled = true;
            } else {
                document.getElementById('checkout-btn').disabled = false;
                document.getElementById('void-btn').disabled = false;
                cart.forEach((item, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-center justify-between rounded-xl p-4 surface-container-low-bg on-surface-text shadow-sm';
                    listItem.innerHTML = `
                        <div class="flex items-center gap-4">
                            <span class="text-2xl">${item.image}</span>
                            <div class="flex-grow">
                                <h4 class="title-medium">${item.name}</h4>
                                <span class="label-large">Â£${(item.price * item.quantity).toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-xl">${item.quantity}</span>
                            <button class="remove-item-btn icon-button p-2 rounded-full" data-index="${index}">
                                <i class="fa-solid fa-circle-xmark"></i>
                            </button>
                        </div>
                    `;
                    cartList.appendChild(listItem);
                });
            }
            updateTotals();
        };

        /**
         * Calculates and updates the total price, tax, and subtotal.
         */
        const updateTotals = () => {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * taxRate;
            const total = subtotal + tax;
            
            taxPercentageSpan.textContent = (taxRate * 100).toFixed(2);
            subtotalAmount.textContent = `Â£${subtotal.toFixed(2)}`;
            taxAmount.textContent = `Â£${tax.toFixed(2)}`;
            totalAmount.textContent = `Â£${total.toFixed(2)}`;
            mobileCartTotalSpan.textContent = `Â£${total.toFixed(2)}`;
        };

        /**
         * Adds an item to the cart or increments its quantity.
         * @param {object} itemToAdd - The item object to add.
         */
        const addItemToCart = (itemToAdd) => {
            const existingItem = cart.find(item => item.id === itemToAdd.id);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ ...itemToAdd, quantity: 1 });
            }
            renderCart();
            // showSnackbar(`Added ${itemToAdd.name} to cart.`);
        };
        
        // --- Event Listeners ---
        
        // Navigation Rail
        navItems.forEach(nav => {
            nav.addEventListener('click', (e) => {
                e.preventDefault();
                const viewId = nav.dataset.view;
                showView(viewId);
            });
        });

        // Checkout & Void
        document.getElementById('checkout-btn').addEventListener('click', () => {
            if (cart.length === 0) {
                showSnackbar("Cart is empty. Add items to checkout.");
                return;
            }
            currentTotal = parseFloat(totalAmount.textContent.substring(1));
            paymentStep1.classList.remove('hidden');
            cashStage1.classList.add('hidden');
            cashStage2.classList.add('hidden');
            showDialog(checkoutDialog);
        });
        
        document.getElementById('void-btn').addEventListener('click', () => {
            if (cart.length > 0) {
                cart = []; // Void the whole order
                renderCart();
                showSnackbar(`Order voided.`);
            } else {
                showSnackbar("Cart is already empty.");
            }
        });

        // Event listener for removing individual items from the cart
        cartList.addEventListener('click', (e) => {
            const removeButton = e.target.closest('.remove-item-btn');
            if (removeButton) {
                const index = parseInt(removeButton.dataset.index);
                const removedItem = cart.splice(index, 1)[0];
                renderCart();
                // showSnackbar(`Removed one ${removedItem.name}.`);
            }
        });
        
        // Mobile cart button logic
        mobileCartBtn.addEventListener('click', () => {
            cartPanel.classList.add('open');
        });

        // Mobile cart close button logic
        closeCartBtn.addEventListener('click', () => {
            cartPanel.classList.remove('open');
        });

        // Checkout Dialog Logic
        document.getElementById('pay-cash-btn').addEventListener('click', () => {
            totalDueDisplay.textContent = `Â£${currentTotal.toFixed(2)}`;
            cashReceivedInput.value = '';
            paymentStep1.classList.add('hidden');
            cashStage1.classList.remove('hidden');
        });

        document.getElementById('pay-card-btn').addEventListener('click', () => {
            showSnackbar('Processing card payment...');
            setTimeout(() => {
                showSnackbar('Payment successful!');
                hideAllDialogs();
                cart = [];
                renderCart();
            }, 1500);
        });
        
        document.getElementById('checkout-cancel-btn').addEventListener('click', hideAllDialogs);
        
        // Cash Stage 1 Logic
        cashBack1Btn.addEventListener('click', () => {
            cashStage1.classList.add('hidden');
            paymentStep1.classList.remove('hidden');
        });

        cashReceivedInput.addEventListener('input', () => {
            // This is just to allow input, no calculation until continue is clicked
        });

        // Preset cash buttons logic
        cashPresetButtons.forEach(button => {
            button.addEventListener('click', () => {
                const value = button.dataset.value;
                cashReceivedInput.value = parseFloat(value).toFixed(2);
            });
        });

        // Exact cash button logic
        exactCashButton.addEventListener('click', () => {
            cashReceivedInput.value = currentTotal.toFixed(2);
        });
        
        // Cash Stage 1 -> Stage 2 transition
        cashContinueBtn.addEventListener('click', () => {
            const received = parseFloat(cashReceivedInput.value);
            if (received >= currentTotal) {
                const change = received - currentTotal;
                totalDisplaySmall.textContent = `Â£${currentTotal.toFixed(2)}`;
                changeDisplay.textContent = `Â£${change.toFixed(2)}`;
                cashStage1.classList.add('hidden');
                cashStage2.classList.remove('hidden');
            } else {
                showSnackbar('Insufficient cash received.');
            }
        });
        
        // Cash Stage 2 Logic
        cashBack2Btn.addEventListener('click', () => {
            cashStage2.classList.add('hidden');
            cashStage1.classList.remove('hidden');
        });

        completeTransactionBtn.addEventListener('click', () => {
            showSnackbar('Transaction complete. Change has been given.');
            hideAllDialogs();
            cart = [];
            renderCart();
        });

        // Items Management Logic
        document.getElementById('add-item-btn').addEventListener('click', () => {
            document.getElementById('item-form-title').textContent = 'Add New Item';
            document.getElementById('item-form').reset();
            editItemIndex = -1; // Reset edit state
            showDialog(itemFormDialog);
        });
        
        document.getElementById('item-form-cancel-btn').addEventListener('click', () => {
            hideAllDialogs();
        });
        
        document.getElementById('item-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('item-name').value;
            const price = parseFloat(document.getElementById('item-price').value);
            const emoji = document.getElementById('item-emoji').value;

            if (editItemIndex !== -1) {
                // Logic for editing an existing item
                products[editItemIndex] = { ...products[editItemIndex], name, price, image: emoji };
                showSnackbar(`Updated "${name}".`);
            } else {
                // Logic for adding a new item
                const newItem = {
                    id: `p_${products.length + 1}`,
                    name,
                    price,
                    image: emoji,
                };
                products.push(newItem);
                showSnackbar(`Added new item: "${name}".`);
            }
            saveCatalog();
            hideAllDialogs();
            renderCatalogList();
            renderItems();
        });

        const renderCatalogList = () => {
            catalogList.innerHTML = '';
            products.forEach((item, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'flex items-center justify-between rounded-xl p-4 surface-container-low-bg on-surface-text shadow-sm';
                listItem.innerHTML = `
                    <div class="flex items-center gap-4">
                        <span class="text-2xl">${item.image}</span>
                        <div>
                            <h4 class="title-medium">${item.name}</h4>
                            <span class="label-large">Â£${item.price.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-item-btn text-button p-2 rounded-full" data-index="${index}">Edit</button>
                        <button class="delete-item-btn text-button p-2 rounded-full error-text" data-index="${index}">Delete</button>
                    </div>
                `;
                catalogList.appendChild(listItem);
            });
        };

        catalogList.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-item-btn');
            const deleteButton = e.target.closest('.delete-item-btn');
            
            if (editButton) {
                const index = parseInt(editButton.dataset.index);
                const item = products[index];
                document.getElementById('item-form-title').textContent = `Edit "${item.name}"`;
                document.getElementById('item-name').value = item.name;
                document.getElementById('item-price').value = item.price;
                document.getElementById('item-emoji').value = item.image;
                editItemIndex = index;
                showDialog(itemFormDialog);
            } else if (deleteButton) {
                const index = parseInt(deleteButton.dataset.index);
                const removedItem = products.splice(index, 1)[0];
                saveCatalog();
                renderCatalogList();
                renderItems();
                showSnackbar(`Removed "${removedItem.name}" from catalog.`);
            }
        });

        // Search functionality
        itemSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = products.filter(item => 
                item.name.toLowerCase().includes(searchTerm)
            );
            renderItems(filtered);
        });

        // Settings View Logic
        document.getElementById('save-tax-btn').addEventListener('click', () => {
            let newTaxRate = parseFloat(taxRateInput.value) / 100;
            if (newTaxRate >= 0 && newTaxRate <= 1) {
                taxRate = newTaxRate;
                saveTaxRate();
                updateTotals();
                currentTaxRateSpan.textContent = (taxRate * 100).toFixed(2);
                showSnackbar(`Tax rate updated to ${taxRate * 100}%.`);
            } else {
                showSnackbar("Please enter a valid percentage between 0 and 100.");
            }
        });
        
        // Slider Logic
        columnSlider.addEventListener('input', (e) => {
            gridColumns = e.target.value;
            columnCountDisplay.textContent = gridColumns;
            document.documentElement.style.setProperty('--grid-columns', gridColumns);
            columnSlider.setAttribute('data-value', gridColumns); // Update the pseudo-element value
            
            // Update the filled track based on the new value
            const percentage = ((columnSlider.value - columnSlider.min) / (columnSlider.max - columnSlider.min)) * 100;
            document.documentElement.style.setProperty('--thumb-position', `${percentage}%`);
        });
        
        columnSlider.addEventListener('change', () => {
            saveGridColumns();
        });

        // Initial setup
        window.onload = () => {
            loadState();
            renderItems();
            renderCart();
            showView('sale');
            
            // Set initial slider values
            columnSlider.value = gridColumns;
            columnCountDisplay.textContent = gridColumns;
            document.documentElement.style.setProperty('--grid-columns', gridColumns);
            columnSlider.setAttribute('data-value', gridColumns);
            const percentage = ((columnSlider.value - columnSlider.min) / (columnSlider.max - columnSlider.min)) * 100;
            document.documentElement.style.setProperty('--thumb-position', `${percentage}%`);

            // Add mobile-specific classes
            if (window.innerWidth < 768) {
                cartPanel.classList.add('mobile-overlay');
            } else {
                cartPanel.classList.remove('mobile-overlay', 'open');
            }
        };

        // Handle window resize for responsiveness
        window.onresize = () => {
            if (window.innerWidth < 768) {
                cartPanel.classList.add('mobile-overlay');
            } else {
                cartPanel.classList.remove('mobile-overlay', 'open');
            }
        };
    </script>
</body>
</html>
